<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LearnEdge ‚Äì Lista u≈ºytkownik√≥w</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- G≈Ç√≥wny styl -->
    <link th:href="@{/css/pages/dashboard.css}" href="../../static/css/pages/dashboard.css" rel="stylesheet" />

</head>

<body>
<!-- Navbar -->
<nav th:replace="~{fragments/nav :: navbar}"></nav>

<div class="container py-5">
    <div class="dashboard-container">

        <div class="dashboard-header text-center mb-4">
            <h1 class="mb-2">Panel Administratora</h1>
            <p class="text-light opacity-75 small mb-0">
                ZarzƒÖdzaj u≈ºytkownikami, kursami i monitoruj aktywno≈õƒá platformy.
            </p>
        </div>

        <!-- Statystyki -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-icon"><i class="bi bi-people"></i></div>
                    <h5>U≈ºytkownicy</h5>
                    <h3>128</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-icon"><i class="bi bi-journal-bookmark"></i></div>
                    <h5>Kursy</h5>
                    <h3>42</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-icon"><i class="bi bi-activity"></i></div>
                    <h5>Aktywni uczniowie</h5>
                    <h3>86</h3>
                </div>
            </div>
        </div>

        <!-- === SEKCJA U≈ªYTKOWNIK√ìW (dynamiczna) === -->
        <div class="admin-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="bi bi-person-lines-fill me-2"></i> U≈ºytkownicy</h5>
            </div>

            <ul class="user-list mb-0"><!-- TU JS WSTAWI U≈ªYTKOWNIK√ìW --></ul>
        </div>

        <!-- Kursy (nie ruszam) -->
        <div class="admin-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="bi bi-journal-bookmark me-2"></i> Kursy</h5>
                <button class="btn btn-gradient btn-sm">
                    <i class="bi bi-plus-circle me-2"></i> Dodaj kurs
                </button>
            </div>

            <ul class="course-list mb-0">
                <!-- Tw√≥j kod kurs√≥w zostaje bez zmian -->
            </ul>
        </div>

        <!-- Aktywno≈õci -->
        <div class="admin-section">
            <h5><i class="bi bi-clipboard-data me-2"></i> Ostatnie aktywno≈õci</h5>
            <ul class="text-light small mb-0">
                <li>üìò Dodano nowy kurs: <strong>Efektywne uczenie siƒô</strong></li>
                <li>üë§ U≈ºytkownik <strong>Jan Kowalski</strong> zmieni≈Ç styl na <em>Kinestetyk</em></li>
                <li>üóëÔ∏è Usuniƒôto kurs: <strong>Podstawy HTML</strong></li>
            </ul>
        </div>

    </div>
</div>

<!-- === MODAL: Edycja u≈ºytkownika === -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="dashboard-container p-4">

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-white d-flex align-items-center">
                        <i class="bi bi-person-gear me-2 text-accent"></i> Edytuj u≈ºytkownika
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <form id="editUserForm">
                    <input type="hidden" id="userId" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label text-light small">Imiƒô i nazwisko</label>
                            <input type="text" class="form-control text-white" id="userName" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label text-light small">Adres e-mail</label>
                            <input type="email" class="form-control text-white" id="userEmail" />
                        </div>

                        <div class="col-md-12">
                            <label class="form-label text-light small">Styl uczenia siƒô</label>
                            <select id="userStyle" class="form-select custom-select-learnedge">
                                <option value="VISUAL">üëÅÔ∏è Wzrokowiec</option>
                                <option value="AUDITORY">üéß S≈Çuchowiec</option>
                                <option value="KINESTHETIC">‚úã Kinestetyk</option>
                            </select>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label text-light small">Rola u≈ºytkownika</label>
                            <select id="userRole" class="form-select custom-select-learnedge">
                                <option value="USER">U≈ºytkownik</option>
                                <option value="MODERATOR">Moderator</option>
                                <option value="ADMIN">Administrator</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">
                            Anuluj
                        </button>
                        <button type="submit" class="btn btn-gradient">
                            <i class="bi bi-save2 me-2"></i>Zapisz zmiany
                        </button>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>

<!-- === SKRYPTY === -->
<script>
    let selectedUserId = null;

    // ≈Åadowanie listy u≈ºytkownik√≥w
    async function loadUsers() {
      const res = await fetch("/api/admin/users");
      const users = await res.json();

      const list = document.querySelector(".user-list");
      list.innerHTML = "";

      users.forEach(u => {
        const li = document.createElement("li");
        li.className = "d-flex justify-content-between align-items-start flex-wrap";

        li.innerHTML = `
          <div class="me-3">
            <span class="fw-bold">${u.firstName ?? ""} ${u.lastName ?? ""}</span>
            <p class="small text-light opacity-75 mb-1">${u.email}</p>

            <span class="badge badge-style-${(u.learningStyle || "").toLowerCase()}">
              ${styleLabel(u.learningStyle)}
            </span>

            <span class="small opacity-75 ms-2">‚Ä¢ Rola: ${u.role.replace("ROLE_", "")}</span>
          </div>

          <div class="d-flex gap-2 mt-2 mt-sm-0">
            <button class="btn btn-sm btn-edit btn-action" onclick="openEditUser(${u.id})">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-delete btn-action" onclick="deleteUser(${u.id})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;

        list.appendChild(li);
      });
    }

    function styleLabel(style) {
      return {
        VISUAL: "üëÅÔ∏è Wzrokowiec",
        AUDITORY: "üéß S≈Çuchowiec",
        KINESTHETIC: "‚úã Kinestetyk"
      }[style] ?? "";
    }

    // Otwieranie modala
    async function openEditUser(id) {
      selectedUserId = id;

      const res = await fetch(`/api/admin/users/${id}`);
      const u = await res.json();

      document.getElementById("userId").value = id;
      document.getElementById("userName").value =
    `${u.firstName ?? "Brak"} ${u.lastName ?? "Nazwy"}`;
      document.getElementById("userEmail").value = u.email;
      document.getElementById("userStyle").value = u.learningStyle ?? "VISUAL";
      document.getElementById("userRole").value = (u.role?.replace("ROLE_", "")) ?? "USER";

      new bootstrap.Modal('#editUserModal').show();
    }

    // Zapisywanie zmian
    document.getElementById("editUserForm").addEventListener("submit", async e => {
      e.preventDefault();

      const [firstName, lastName] = document.getElementById("userName").value.split(" ");

      const body = {
        firstName,
        lastName,
        email: document.getElementById("userEmail").value,
        learningStyle: document.getElementById("userStyle").value,
        role: "ROLE_" + document.getElementById("userRole").value
      };

      await fetch(`/api/admin/users/${selectedUserId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      bootstrap.Modal.getInstance(document.getElementById("editUserModal")).hide();
      loadUsers();
    });

    // Usuwanie u≈ºytkownika
    async function deleteUser(id) {
      if (!confirm("Czy na pewno chcesz usunƒÖƒá u≈ºytkownika?")) return;
      await fetch(`/api/admin/users/${id}`, { method: "DELETE" });
      loadUsers();
    }

    loadUsers();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

