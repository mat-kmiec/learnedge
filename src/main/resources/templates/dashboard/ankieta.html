<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>LearnEdge – Ankieta AI</title>
    <link rel="icon" type="image/x-icon" th:href="@{/img/favicon.ico}"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <link th:href="@{/css/pages/dashboard.css}" rel="stylesheet"/>
    <style>
      .question-container {
        display: none;
        min-height: 400px;
      }
      .question-container.active {
        display: block;
        animation: fadeIn 0.4s ease-out;
      }
      @keyframes fadeIn {
        from { 
          opacity: 0; 
          transform: translateX(20px);
        }
        to { 
          opacity: 1; 
          transform: translateX(0);
        }
      }
      .progress-bar-container {
        margin-bottom: 40px;
        padding: 20px;
        background: rgba(255,255,255,0.03);
        border-radius: 12px;
      }
      .progress {
        height: 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        overflow: hidden;
      }
      .question-number {
        font-size: 0.85rem;
        color: var(--accent-color);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 15px;
      }
      .question-container h5 {
        font-size: 1.5rem;
        line-height: 1.5;
        color: #fff;
        margin-bottom: 30px;
      }
      .answer-option {
        display: block;
        padding: 18px 24px;
        margin: 12px 0;
        border: 2px solid rgba(255,255,255,0.15);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.25s ease;
        background: rgba(255,255,255,0.05);
        font-size: 1.05rem;
        position: relative;
        overflow: hidden;
      }
      .answer-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--accent-color);
        transform: scaleY(0);
        transition: transform 0.25s ease;
      }
      .answer-option:hover {
        border-color: var(--accent-color);
        background: rgba(255,255,255,0.1);
        transform: translateX(4px);
      }
      .answer-option:hover::before {
        transform: scaleY(1);
      }
      .answer-option.selected {
        border-color: var(--accent-color);
        background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.25), rgba(var(--accent-rgb), 0.15));
        box-shadow: 0 4px 20px rgba(var(--accent-rgb), 0.3);
      }
      .answer-option.selected::before {
        transform: scaleY(1);
      }
      .answer-option input[type="radio"] {
        margin-right: 15px;
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--accent-color);
      }
      .answer-option label {
        cursor: pointer;
        user-select: none;
      }
      .navigation-buttons {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        margin-top: 40px;
        flex-wrap: wrap;
      }
      .btn-nav {
        flex: 1;
        min-width: 120px;
        padding: 14px 20px;
        font-size: 1rem;
        font-weight: 500;
        border-radius: 10px;
        transition: all 0.3s ease;
      }
      .btn-nav:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      }
      .btn-outline-secondary {
        background: transparent;
        border: 2px solid rgba(255,255,255,0.2);
        color: rgba(255,255,255,0.8);
      }
      .btn-outline-secondary:hover {
        background: rgba(255,255,255,0.1);
        border-color: rgba(255,255,255,0.3);
        color: #fff;
      }
      textarea.form-control {
        background: rgba(255,255,255,0.05);
        border: 2px solid rgba(255,255,255,0.15);
        color: #fff;
        padding: 15px;
        font-size: 1rem;
        border-radius: 10px;
        resize: vertical;
      }
      textarea.form-control:focus {
        background: rgba(255,255,255,0.08);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--accent-rgb), 0.25);
      }
      textarea.form-control::placeholder {
        color: rgba(255,255,255,0.4);
      }
      
      /* Toast notification system */
      .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 400px;
      }
      .toast-notification {
        display: flex;
        align-items: center;
        gap: 15px;
        background: linear-gradient(135deg, rgba(30, 30, 30, 0.98), rgba(20, 20, 20, 0.98));
        border: 2px solid var(--accent-color);
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(var(--accent-rgb), 0.3);
        backdrop-filter: blur(10px);
        animation: slideInRight 0.4s ease-out;
        color: #fff;
      }
      .toast-notification.toast-hide {
        animation: slideOutRight 0.4s ease-out forwards;
      }
      @keyframes slideInRight {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
      .toast-logo {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .toast-logo img {
        width: 28px;
        height: 28px;
        object-fit: contain;
      }
      .toast-message {
        flex: 1;
        font-size: 0.95rem;
        line-height: 1.4;
      }
      .toast-close {
        flex-shrink: 0;
        background: transparent;
        border: none;
        color: rgba(255,255,255,0.6);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s ease;
      }
      .toast-close:hover {
        color: #fff;
      }
    </style>
  </head>

  <body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <div th:replace="~{fragments/nav :: navbar}"></div>

    <div class="container py-5">
      <div class="dashboard-container">
        <div class="dashboard-header text-center mb-4">
          <h1 class="mb-2">Ankieta AI – Poznaj swój styl uczenia się</h1>
          <p class="text-light opacity-75 small mb-0">
            Odpowiedz na pytania, a AI dopasuje najlepszy styl nauki dla Ciebie
          </p>
          
          <div th:if="${aiAvailable}" class="alert alert-success mt-3">
            <i class="bi bi-robot me-2"></i>
            AI jest gotowe do analizy!
          </div>
        </div>

        <!-- Progress bar -->
        <div class="progress-bar-container">
          <div class="d-flex justify-content-between mb-2">
            <span class="small">Postęp</span>
            <span class="small"><span id="currentQuestion">1</span> / <span id="totalQuestions">13</span></span>
          </div>
          <div class="progress">
            <div id="progressBar" class="progress-bar bg-accent" role="progressbar" style="width: 8%"></div>
          </div>
        </div>

        <form id="learningStyleForm">
          <!-- Pytanie 1 -->
          <div class="question-container active" data-question="1">
            <div class="question-number">Pytanie 1 z 20</div>
            <h5 class="fw-bold mb-4">Kiedy uczysz się czegoś nowego, najłatwiej zapamiętujesz gdy...</h5>
            <label class="answer-option">
              <input type="radio" name="q1" value="visual"/>
              widzę schemat lub obrazek
            </label>
            <label class="answer-option">
              <input type="radio" name="q1" value="auditory"/>
              ktoś mi to tłumaczy
            </label>
            <label class="answer-option">
              <input type="radio" name="q1" value="kinesthetic"/>
              mogę to sam wypróbować
            </label>
          </div>

          <!-- Pytanie 2 -->
          <div class="question-container" data-question="2">
            <div class="question-number">Pytanie 2 z 20</div>
            <h5 class="fw-bold mb-4">Co najczęściej robisz w czasie nauki?</h5>
            <label class="answer-option">
              <input type="radio" name="q2" value="visual"/>
              robię notatki i rysunki
            </label>
            <label class="answer-option">
              <input type="radio" name="q2" value="auditory"/>
              czytam na głos lub słucham nagrań
            </label>
            <label class="answer-option">
              <input type="radio" name="q2" value="kinesthetic"/>
              gestykuluję lub poruszam się
            </label>
          </div>

          <!-- Pytanie 3 -->
          <div class="question-container" data-question="3">
            <div class="question-number">Pytanie 3 z 20</div>
            <h5 class="fw-bold mb-4">Podczas prezentacji wolisz gdy:</h5>
            <label class="answer-option">
              <input type="radio" name="q3" value="visual"/>
              pokazywane są slajdy i grafiki
            </label>
            <label class="answer-option">
              <input type="radio" name="q3" value="auditory"/>
              prowadzący mówi płynnie i wyraźnie
            </label>
            <label class="answer-option">
              <input type="radio" name="q3" value="kinesthetic"/>
              możesz coś robić rękami lub poruszać się
            </label>
          </div>

          <!-- Pytanie 4 -->
          <div class="question-container" data-question="4">
            <div class="question-number">Pytanie 4 z 20</div>
            <h5 class="fw-bold mb-4">Kiedy tłumaczysz drogę komuś:</h5>
            <label class="answer-option">
              <input type="radio" name="q4" value="visual"/>
              rysujesz mapkę lub pokazujesz
            </label>
            <label class="answer-option">
              <input type="radio" name="q4" value="auditory"/>
              dokładnie opisujesz słowami
            </label>
            <label class="answer-option">
              <input type="radio" name="q4" value="kinesthetic"/>
              gestykulujesz i wskazujesz kierunki
            </label>
          </div>

          <!-- Pytanie 5 -->
          <div class="question-container" data-question="5">
            <div class="question-number">Pytanie 5 z 20</div>
            <h5 class="fw-bold mb-4">W wolnym czasie najchętniej:</h5>
            <label class="answer-option">
              <input type="radio" name="q5" value="visual"/>
              czytam książki lub oglądam filmy
            </label>
            <label class="answer-option">
              <input type="radio" name="q5" value="auditory"/>
              słucham muzyki lub podcastów
            </label>
            <label class="answer-option">
              <input type="radio" name="q5" value="kinesthetic"/>
              uprawiam sport lub hobby manualne
            </label>
          </div>

          <!-- Pytanie 6 -->
          <div class="question-container" data-question="6">
            <div class="question-number">Pytanie 6 z 20</div>
            <h5 class="fw-bold mb-4">Gdy muszę zapamiętać numer telefonu:</h5>
            <label class="answer-option">
              <input type="radio" name="q6" value="visual"/>
              zapisuję go lub wyobrażam sobie cyfry
            </label>
            <label class="answer-option">
              <input type="radio" name="q6" value="auditory"/>
              powtarzam go sobie na głos
            </label>
            <label class="answer-option">
              <input type="radio" name="q6" value="kinesthetic"/>
              wystukuję rytm cyframi
            </label>
          </div>

          <!-- Pytanie 7 -->
          <div class="question-container" data-question="7">
            <div class="question-number">Pytanie 7 z 20</div>
            <h5 class="fw-bold mb-4">Podczas nauki języka obcego wolę:</h5>
            <label class="answer-option">
              <input type="radio" name="q7" value="visual"/>
              czytać teksty i oglądać napisy
            </label>
            <label class="answer-option">
              <input type="radio" name="q7" value="auditory"/>
              słuchać nagrań i rozmawiać
            </label>
            <label class="answer-option">
              <input type="radio" name="q7" value="kinesthetic"/>
              ćwiczyć przez pisanie i gesty
            </label>
          </div>

          <!-- Pytanie 8 -->
          <div class="question-container" data-question="8">
            <div class="question-number">Pytanie 8 z 20</div>
            <h5 class="fw-bold mb-4">W sklepie najłatwiej znajduję produkty gdy:</h5>
            <label class="answer-option">
              <input type="radio" name="q8" value="visual"/>
              mam listę zapisaną lub pamiętam gdzie są
            </label>
            <label class="answer-option">
              <input type="radio" name="q8" value="auditory"/>
              pytam sprzedawcę
            </label>
            <label class="answer-option">
              <input type="radio" name="q8" value="kinesthetic"/>
              przechodzę po sklepie i szukam
            </label>
          </div>

          <!-- Pytanie 9 -->
          <div class="question-container" data-question="9">
            <div class="question-number">Pytanie 9 z 20</div>
            <h5 class="fw-bold mb-4">Przy rozwiązywaniu problemów matematycznych:</h5>
            <label class="answer-option">
              <input type="radio" name="q9" value="visual"/>
              rysuję schematy i wykresy
            </label>
            <label class="answer-option">
              <input type="radio" name="q9" value="auditory"/>
              dyskutuję z innymi lub mówię na głos
            </label>
            <label class="answer-option">
              <input type="radio" name="q9" value="kinesthetic"/>
              używam klocków, liczydła lub palców
            </label>
          </div>

          <!-- Pytanie 10 -->
          <div class="question-container" data-question="10">
            <div class="question-number">Pytanie 10 z 20</div>
            <h5 class="fw-bold mb-4">Gdy się stresuję przed egzaminem:</h5>
            <label class="answer-option">
              <input type="radio" name="q10" value="visual"/>
              przeglądam notatki i podsumowania
            </label>
            <label class="answer-option">
              <input type="radio" name="q10" value="auditory"/>
              rozmawiam z kimś o materiale
            </label>
            <label class="answer-option">
              <input type="radio" name="q10" value="kinesthetic"/>
              chodzę lub ruszam się
            </label>
          </div>

          <!-- Pytanie 11 -->
          <div class="question-container" data-question="11">
            <div class="question-number">Pytanie 11 z 20</div>
            <h5 class="fw-bold mb-4">Najlepiej koncentruję się gdy:</h5>
            <label class="answer-option">
              <input type="radio" name="q11" value="visual"/>
              mam uporządkowane miejsce pracy
            </label>
            <label class="answer-option">
              <input type="radio" name="q11" value="auditory"/>
              jest cicho lub gra spokojna muzyka
            </label>
            <label class="answer-option">
              <input type="radio" name="q11" value="kinesthetic"/>
              mogę się ruszać lub mam coś w rękach
            </label>
          </div>

          <!-- Pytanie 12 -->
          <div class="question-container" data-question="12">
            <div class="question-number">Pytanie 12 z 20</div>
            <h5 class="fw-bold mb-4">Podczas robienia notatek:</h5>
            <label class="answer-option">
              <input type="radio" name="q12" value="visual"/>
              używam kolorów, podkreśleń i schematów
            </label>
            <label class="answer-option">
              <input type="radio" name="q12" value="auditory"/>
              przepisuję lub nagrywam własne tłumaczenia
            </label>
            <label class="answer-option">
              <input type="radio" name="q12" value="kinesthetic"/>
              piszę szybko, często bazgrołami
            </label>
          </div>

          <!-- Pytanie 13 -->
          <div class="question-container" data-question="13">
            <div class="question-number">Pytanie 13 z 20</div>
            <h5 class="fw-bold mb-4">Przy montażu mebli z instrukcją:</h5>
            <label class="answer-option">
              <input type="radio" name="q13" value="visual"/>
              dokładnie studiuję rysunki
            </label>
            <label class="answer-option">
              <input type="radio" name="q13" value="auditory"/>
              proszę kogoś o pomoc lub tłumaczenie
            </label>
            <label class="answer-option">
              <input type="radio" name="q13" value="kinesthetic"/>
              zaczynam składać metodą prób i błędów
            </label>
          </div>

          <!-- Pytanie 14 -->
          <div class="question-container" data-question="14">
            <div class="question-number">Pytanie 14 z 20</div>
            <h5 class="fw-bold mb-4">Kiedy uczę się nowego słowa:</h5>
            <label class="answer-option">
              <input type="radio" name="q14" value="visual"/>
              widzę je napisane i wizualizuję
            </label>
            <label class="answer-option">
              <input type="radio" name="q14" value="auditory"/>
              powtarzam je głośno kilka razy
            </label>
            <label class="answer-option">
              <input type="radio" name="q14" value="kinesthetic"/>
              zapisuję je lub układam z liter
            </label>
          </div>

          <!-- Pytanie 15 -->
          <div class="question-container" data-question="15">
            <div class="question-number">Pytanie 15 z 20</div>
            <h5 class="fw-bold mb-4">Podczas oglądania filmu edukacyjnego:</h5>
            <label class="answer-option">
              <input type="radio" name="q15" value="visual"/>
              koncentruję się na obrazach i animacjach
            </label>
            <label class="answer-option">
              <input type="radio" name="q15" value="auditory"/>
              najbardziej pamiętam komentarz lektora
            </label>
            <label class="answer-option">
              <input type="radio" name="q15" value="kinesthetic"/>
              chcę spróbować tego, co pokazano
            </label>
          </div>

          <!-- Pytanie 16 -->
          <div class="question-container" data-question="16">
            <div class="question-number">Pytanie 16 z 20</div>
            <h5 class="fw-bold mb-4">Gdy spotykam nową osobę, najlepiej zapamiętam:</h5>
            <label class="answer-option">
              <input type="radio" name="q16" value="visual"/>
              jej wygląd i twarz
            </label>
            <label class="answer-option">
              <input type="radio" name="q16" value="auditory"/>
              jej imię i głos
            </label>
            <label class="answer-option">
              <input type="radio" name="q16" value="kinesthetic"/>
              jak się czułem podczas spotkania
            </label>
          </div>

          <!-- Pytanie 17 -->
          <div class="question-container" data-question="17">
            <div class="question-number">Pytanie 17 z 20</div>
            <h5 class="fw-bold mb-4">Podczas czytania książki wolę:</h5>
            <label class="answer-option">
              <input type="radio" name="q17" value="visual"/>
              wyobrażać sobie scenę w myślach
            </label>
            <label class="answer-option">
              <input type="radio" name="q17" value="auditory"/>
              czytać ze słyszeniem słów w głowie
            </label>
            <label class="answer-option">
              <input type="radio" name="q17" value="kinesthetic"/>
              czuć emocje i napięcie akcji
            </label>
          </div>

          <!-- Pytanie 18 -->
          <div class="question-container" data-question="18">
            <div class="question-number">Pytanie 18 z 20</div>
            <h5 class="fw-bold mb-4">Kiedy muszę zapamiętać listę rzeczy do zrobienia:</h5>
            <label class="answer-option">
              <input type="radio" name="q18" value="visual"/>
              piszę listę lub robię mind mapę
            </label>
            <label class="answer-option">
              <input type="radio" name="q18" value="auditory"/>
              powtarzam sobie na głos lub nagrywam
            </label>
            <label class="answer-option">
              <input type="radio" name="q18" value="kinesthetic"/>
              układam zadania fizycznie (karteczki)
            </label>
          </div>

          <!-- Pytanie 19 -->
          <div class="question-container" data-question="19">
            <div class="question-number">Pytanie 19 z 20</div>
            <h5 class="fw-bold mb-4">Na wykładzie najlepiej uczę się gdy:</h5>
            <label class="answer-option">
              <input type="radio" name="q19" value="visual"/>
              mam prezentację i slajdy do podglądu
            </label>
            <label class="answer-option">
              <input type="radio" name="q19" value="auditory"/>
              słucham wykładowcy i dyskusji
            </label>
            <label class="answer-option">
              <input type="radio" name="q19" value="kinesthetic"/>
              mogę robić ćwiczenia i eksperymenty
            </label>
          </div>

          <!-- Pytanie 20 -->
          <div class="question-container" data-question="20">
            <div class="question-number">Pytanie 20 z 20</div>
            <h5 class="fw-bold mb-4">Podczas nauki na egzamin wolę:</h5>
            <label class="answer-option">
              <input type="radio" name="q20" value="visual"/>
              czytać podręczniki i przeglądać notatki
            </label>
            <label class="answer-option">
              <input type="radio" name="q20" value="auditory"/>
              słuchać nagrań lub dyskutować z innymi
            </label>
            <label class="answer-option">
              <input type="radio" name="q20" value="kinesthetic"/>
              robić quizy i rozwiązywać zadania praktyczne
            </label>
          </div>

          <!-- Opis tekstowy (opcjonalny - na końcu) -->
          <div class="question-container" data-question="21">
            <div class="question-number">Dodatkowy opis</div>
            <h5 class="fw-bold mb-4">Opisz swoimi słowami, jak najchętniej się uczysz:</h5>
            <textarea 
              class="form-control" 
              name="userDescription" 
              rows="5" 
              placeholder="Np. Lubię oglądać filmy edukacyjne i czytać książki z ilustracjami..."></textarea>
            <div class="text-muted small mt-2">
              <i class="bi bi-info-circle"></i>
              Ten opis pomoże AI lepiej określić Twój styl uczenia
            </div>
          </div>

          <!-- Navigation buttons -->
          <div class="navigation-buttons">
            <button type="button" class="btn btn-secondary btn-nav" id="prevBtn" onclick="changeQuestion(-1)">
              <i class="bi bi-arrow-left me-2"></i>Wstecz
            </button>
            <button type="button" class="btn btn-outline-secondary btn-nav" id="skipBtn" onclick="skipQuestion()">
              <i class="bi bi-skip-forward me-2"></i>Pomiń
            </button>
            <button type="button" class="btn btn-primary btn-nav" id="nextBtn" onclick="changeQuestion(1)">
              Dalej<i class="bi bi-arrow-right ms-2"></i>
            </button>
            <button type="submit" class="btn btn-accent btn-nav" id="submitBtn" style="display: none;">
              <i class="bi bi-check-circle me-2"></i>Zakończ ankietę
            </button>
          </div>
        </form>

        <!-- Wynik -->
        <div id="aiResult" class="d-none">
          <div class="alert alert-success text-center">
            <h4 class="mb-3"><i class="bi bi-check-circle-fill me-2"></i>Analiza zakończona!</h4>
            <div id="aiOutput" class="fs-5"></div>
            <a href="/profil" class="btn btn-accent mt-3">Przejdź do profilu</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentQuestionIndex = 1;
      const totalQuestions = 21; // 20 pytań + opis tekstowy
      
      // Toast notification system
      function showToast(message, duration = 5000) {
        const container = document.getElementById('toastContainer');
        
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        
        toast.innerHTML = `
          <div class="toast-logo">
            <img src="/img/logo-icon.png" alt="LearnEdge">
          </div>
          <div class="toast-message">${message}</div>
          <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="bi bi-x"></i>
          </button>
        `;
        
        container.appendChild(toast);
        
        // Auto-hide after duration
        setTimeout(() => {
          toast.classList.add('toast-hide');
          setTimeout(() => toast.remove(), 400);
        }, duration);
      }
      
      // CSRF token
      function getCsrfToken() {
        const csrfMeta = document.querySelector('meta[name="_csrf"]');
        return csrfMeta ? csrfMeta.getAttribute('content') : '';
      }
      
      function getCsrfHeader() {
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        return csrfHeaderMeta ? csrfHeaderMeta.getAttribute('content') : 'X-CSRF-TOKEN';
      }

      // Nawigacja między pytaniami
      function showQuestion(index) {
        document.querySelectorAll('.question-container').forEach(q => q.classList.remove('active'));
        const question = document.querySelector(`[data-question="${index}"]`);
        if (question) {
          question.classList.add('active');
          currentQuestionIndex = index;
          updateProgress();
          updateButtons();
        }
      }

      function changeQuestion(direction) {
        const newIndex = currentQuestionIndex + direction;
        if (newIndex >= 1 && newIndex <= totalQuestions) {
          showQuestion(newIndex);
        }
      }

      function skipQuestion() {
        changeQuestion(1);
      }

      function updateProgress() {
        const progress = (currentQuestionIndex / totalQuestions) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('currentQuestion').textContent = currentQuestionIndex;
        document.getElementById('totalQuestions').textContent = totalQuestions;
      }

      function updateButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const skipBtn = document.getElementById('skipBtn');

        prevBtn.style.display = currentQuestionIndex === 1 ? 'none' : 'block';
        
        if (currentQuestionIndex === totalQuestions) {
          nextBtn.style.display = 'none';
          skipBtn.style.display = 'none';
          submitBtn.style.display = 'block';
        } else {
          nextBtn.style.display = 'block';
          skipBtn.style.display = 'block';
          submitBtn.style.display = 'none';
        }
      }

      // Zaznaczanie odpowiedzi
      document.querySelectorAll('.answer-option').forEach(option => {
        option.addEventListener('click', function(e) {
          // Jeśli kliknięto bezpośrednio w radio button, nie rób nic (zostanie obsłużone normalnie)
          if (e.target.tagName === 'INPUT') {
            return;
          }
          
          const radio = this.querySelector('input[type="radio"]');
          if (radio) {
            radio.checked = true;
            
            // Usuń selected z innych opcji w tej samej grupie
            const name = radio.name;
            document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
              r.closest('.answer-option').classList.remove('selected');
            });
            this.classList.add('selected');
          }
        });
      });
      
      // Obsługa bezpośredniego kliknięcia w radio button
      document.querySelectorAll('.answer-option input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const name = this.name;
          document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
            r.closest('.answer-option').classList.remove('selected');
          });
          this.closest('.answer-option').classList.add('selected');
        });
      });

      // Wysyłanie formularza
      document.getElementById('learningStyleForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const surveyData = {};
        
        // Zbierz odpowiedzi z wszystkich pytań (q1-q20)
        for (let i = 1; i <= 20; i++) {
          const answer = formData.get(`q${i}`);
          if (answer) {
            surveyData[`question${i}`] = answer;
          }
        }
        
        // Dodaj opis tekstowy
        const userDescription = formData.get("userDescription");
        if (userDescription && userDescription.trim()) {
          surveyData["userDescription"] = userDescription.trim();
        }
        
        const answeredQuestions = Object.keys(surveyData).filter(key => key.startsWith('question')).length;
        
        // Walidacja
        if (answeredQuestions === 0 && (!surveyData.userDescription || surveyData.userDescription.length < 10)) {
          showToast('Proszę odpowiedzieć na przynajmniej jedno pytanie lub podać opis.');
          return;
        }

        try {
          const submitBtn = document.getElementById('submitBtn');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> Analizuję...';
          submitBtn.disabled = true;

          const headers = {
            'Content-Type': 'application/json',
          };
          
          const csrfToken = getCsrfToken();
          if (csrfToken) {
            headers[getCsrfHeader()] = csrfToken;
          }

          const response = await fetch('/api/survey/analyze', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(surveyData)
          });

          const result = await response.json();

          if (result.success) {
            document.getElementById('learningStyleForm').classList.add('d-none');
            document.querySelector('.progress-bar-container').classList.add('d-none');
            document.getElementById('aiResult').classList.remove('d-none');
            document.getElementById('aiOutput').innerHTML = 
              `<strong class="text-accent">${result.message}</strong>`;
          } else {
            showToast('Błąd: ' + (result.error || 'Nie udało się przeanalizować ankiety'));
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          }
        } catch (error) {
          console.error('Błąd sieci:', error);
          showToast('Wystąpił błąd podczas analizy. Spróbuj ponownie.');
          const submitBtn = document.getElementById('submitBtn');
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      });

      // Inicjalizacja
      updateProgress();
      updateButtons();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>

